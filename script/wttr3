#!/bin/bash

# --- CONFIG ---
LOC_RW="Rijswijk"
LOC_WK="Bleiswijk"

# --- COLORS ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
RESET='\033[0m'

# --- EMOJI MAPS ---
weather_emoji() {
  case "$1" in
    *â˜€*|*Sunny*|*Clear*) echo "â˜€ï¸" ;;
    *â›…*|*Partly*|*Cloud*) echo "â›…" ;;
    *â˜*|*Overcast*) echo "â˜ï¸" ;;
    *ðŸŒ§*|*Rain*|*Showers*) echo "ðŸŒ§ï¸" ;;
    *â›ˆ*|*Thunder*|*Storm*) echo "â›ˆï¸" ;;
    *â„*|*Snow*|*Sleet*) echo "â„ï¸" ;;
    *ðŸŒ«*|*Fog*) echo "ðŸŒ«ï¸" ;;
    *) echo "ðŸŒ" ;;
  esac
}

# --- FUNCTIONS ---

# Convert wind speed (km/h) to Beaufort scale
get_beaufort() {
  local wind=$1
  case $wind in
    ''|*[!0-9]*) echo "" ;;
    *)
      if   [ "$wind" -le 1 ];   then echo 0
      elif [ "$wind" -le 5 ];   then echo 1
      elif [ "$wind" -le 11 ];  then echo 2
      elif [ "$wind" -le 19 ];  then echo 3
      elif [ "$wind" -le 28 ];  then echo 4
      elif [ "$wind" -le 38 ];  then echo 5
      elif [ "$wind" -le 49 ];  then echo 6
      elif [ "$wind" -le 61 ];  then echo 7
      elif [ "$wind" -le 74 ];  then echo 8
      elif [ "$wind" -le 88 ];  then echo 9
      elif [ "$wind" -le 102 ]; then echo 10
      elif [ "$wind" -le 117 ]; then echo 11
      else echo 12
      fi
      ;;
  esac
}

# Fetch crypto price
get_price() {
  local symbol=$1
  curl -s "https://api.coinbase.com/v2/prices/${symbol}-EUR/buy" | jq -r '.data.amount'
}

# Color based on value
colorize_crypto() {
  local value=$1
  if (( $(echo "$value > 2000" | bc -l) )); then echo "${GREEN}${value}${RESET}"
  elif (( $(echo "$value > 1000" | bc -l) )); then echo "${YELLOW}${value}${RESET}"
  else echo "${RED}${value}${RESET}"
  fi
}

# --- FETCH DATA ---

# Crypto
ETHBASE=$(get_price "ETH")
DOGEBASE=$(get_price "DOGE")
BTCBASE_RAW=$(get_price "BTC")

ETHSHORT=$(echo "$ETHBASE" | cut -c1-4)
DOGESHORT=$(echo "$DOGEBASE" | cut -c1-4)
BTCNUM=$(echo "$BTCBASE_RAW" | awk '{print $1 + 0}')

if (( $(echo "$BTCNUM >= 100000" | bc -l) )); then
  BTCBASE=$(echo "$BTCNUM" | cut -c1-3)
else
  BTCBASE=$(echo "$BTCNUM" | cut -c1-2)
fi
[ "$BTCBASE" = "0" ] && BTCBASE=""

# Weather
WK_RAW=$(curl -s "wttr.in/${LOC_WK}?format=%c+%t+%w" | sed -E 's/\+//g; s/C[[:alpha:]]/C/; s/km\/h//')
RW_RAW=$(curl -s "wttr.in/${LOC_RW}?format=%c+%t+%w" | sed -E 's/\+//g; s/C[[:alpha:]]/C/; s/km\/h//')

WIND_RW=$(echo "$RW_RAW" | grep -oP '\d+' | tail -1)
WIND_WK=$(echo "$WK_RAW" | grep -oP '\d+' | tail -1)

BFT_RW=$(get_beaufort "$WIND_RW")
BFT_WK=$(get_beaufort "$WIND_WK")

ICON_RW=$(weather_emoji "$RW_RAW")
ICON_WK=$(weather_emoji "$WK_RAW")

# --- DISPLAY ---
echo
echo -e "ðŸŒ¤  ${CYAN}Weather & Crypto Dashboard${RESET}"
echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo -e "${MAGENTA}${LOC_WK}${RESET} ${ICON_WK} ${WK_RAW:-WK}  ðŸ’¨ Bft ${BFT_WK:-?}"
echo -e "${MAGENTA}${LOC_RW}${RESET} ${ICON_RW} ${RW_RAW:-RW}  ðŸ’¨ Bft ${BFT_RW:-?}"
echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo -e "ðŸ’° ${YELLOW}DOGE:${RESET} ${DOGESHORT:-DOGE} | ${CYAN}ETH:${RESET} $(colorize_crypto "$ETHSHORT") | ${GREEN}BTC:${RESET} ${BTCBASE:-BTC}"
echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo

# Wait for keypress
read -n 1 -s -p "Press any key to exit..."
echo
sleep 0.2

